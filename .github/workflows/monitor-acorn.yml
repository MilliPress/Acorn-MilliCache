name: Monitor Acorn Versions

on:
  schedule:
    - cron: '0 3 * * 1'  # Weekly on Monday at 3 AM
  workflow_dispatch:

permissions:
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest Acorn versions
        id: acorn
        run: |
          # Get all Acorn versions from Packagist
          VERSIONS=$(curl -s "https://packagist.org/packages/roots/acorn.json" | \
            jq -r '.package.versions | keys[]' | \
            grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | \
            sed 's/^v//' | \
            sort -V)

          # Get latest major versions
          MAJORS=$(echo "$VERSIONS" | cut -d. -f1 | sort -u)
          LATEST_MAJOR=$(echo "$MAJORS" | tail -1)

          echo "Latest major version: $LATEST_MAJOR"
          echo "latest_major=$LATEST_MAJOR" >> $GITHUB_OUTPUT

          # Get our current tested versions from CI workflow
          TESTED=$(grep -oP "acorn: \['\K[^']+(?=')" .github/workflows/ci.yml | \
            sed 's/\.x-dev//g' | \
            sort -u | \
            tail -1)

          echo "Tested major version: $TESTED"
          echo "tested_major=$TESTED" >> $GITHUB_OUTPUT

      - name: Check if new major detected
        id: check
        run: |
          LATEST="${{ steps.acorn.outputs.latest_major }}"
          TESTED="${{ steps.acorn.outputs.tested_major }}"

          if [ "$LATEST" -gt "$TESTED" ]; then
            echo "new_major=true" >> $GITHUB_OUTPUT
            echo "New Acorn major version detected: v$LATEST"
          else
            echo "new_major=false" >> $GITHUB_OUTPUT
            echo "No new major version (latest: $LATEST, tested: $TESTED)"
          fi

      - name: Create issue for new Acorn version
        if: steps.check.outputs.new_major == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const latestMajor = '${{ steps.acorn.outputs.latest_major }}';
            const testedMajor = '${{ steps.acorn.outputs.tested_major }}';

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'acorn-version'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(`Acorn ${latestMajor}`)
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Test compatibility with Acorn ${latestMajor}.x`,
                labels: ['acorn-version', 'enhancement'],
                body: `## New Acorn Major Version Detected

A new major version of Roots Acorn has been released.

- **Latest Major**: v${latestMajor}.x
- **Currently Tested**: v${testedMajor}.x

### Action Required

1. Update \`.github/workflows/ci.yml\` to include \`${latestMajor}.x-dev\` in the test matrix
2. Run CI to verify compatibility
3. Update \`README.md\` requirements if needed

### Checklist

- [ ] Add Acorn ${latestMajor}.x to CI matrix
- [ ] Run tests and verify compatibility
- [ ] Update documentation
- [ ] Close this issue

---

ðŸ¤– Auto-generated by [monitor-acorn workflow](.github/workflows/monitor-acorn.yml)`
              });

              console.log(`Created issue for Acorn v${latestMajor}.x`);
            } else {
              console.log(`Issue already exists for Acorn v${latestMajor}.x`);
            }
